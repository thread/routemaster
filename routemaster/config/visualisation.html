<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
body {
  font: 14px helvetica neue, helvetica, arial, sans-serif;
  margin: 0;
}
#cy {
  height: 100%;
  width: 100%;
  position: absolute;
  left: 0;
  top: 3.5em;
}
#controls {
  background-color: #f0f0f0;
  margin: 0;
}
#controls div {
  display: inline-block;
  padding: 0.5em;
  margin-right: 0.2em;
}
#spacing-factor-input-container {
  top: 0.5em;
  position: relative;
}
.muted {
  color: #666666;
}
.action {
  background-color: orange;
}
.gate {
  background-color: lightBlue;
}
</style>
<title>Visualisation of state machine {{ state_machine_name }}</title>
</head>
<body>
  <script type="text/javascript">
    var state_machine_config = {{ state_machine_config|tojson }};
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.11/cytoscape.js"></script>
  <div id="controls">
    <div id="legend">
      <div class="action">action</div>
      <div class="gate">gate</div>
    </div>
    <div>
      <label>
        Spacing:
        <span id="spacing-factor-input-container">
          <input id="spacing-factor" type="range" onchange="changeSpacing(this.value / 10); return false;" min="1" max="20" step="0.1">
        </span>
        <span id="spacing-factor-display"></span>
      </label>
    </div>
    <div class="muted">Click and drag to move the graph</div>
  </div>
  <div id="cy"></div>
  <script>
    function backgroundColourForNodeClass(nodeClass) {
      var style = getComputedStyle(document.querySelector('#legend ' + nodeClass));
      return style.backgroundColor;
    }

    var layoutOptions = {
      // http://js.cytoscape.org/#layouts/breadthfirst
      name: 'breadthfirst',
      fit: false,
      directed: true,
      padding: 30,
      spacingFactor: 1.35,
      avoidOverlap: false,
      nodeDimensionsIncludeLabels: false,
    };

    function precisionRound(number, precision) {
      var factor = Math.pow(10, precision);
      return Math.round(number * factor) / factor;
    }

    function displaySpacingFactor() {
      document.getElementById('spacing-factor-display').innerHTML = precisionRound(layoutOptions.spacingFactor * 10, 1);
    }

    var cy = cytoscape({
      container: document.querySelector('#cy'),

      boxSelectionEnabled: false,
      autounselectify: true,

      style: cytoscape.stylesheet()
        .selector('node')
          .css({
            'content': 'data(id)',
            'text-valign': 'center',
            'color': 'black',
          })
          .style({
            'shape': 'square',
            'width': 'label',
            'height': 'label',
            'padding': '1em',
          })
        .selector('edge')
          .css({
            'curve-style': 'bezier',
            'target-arrow-shape': 'triangle',
            'target-arrow-color': '#ccc',
            'line-color': '#ccc',
            'width': 1
          })
        .selector(':selected')
          .css({
            'background-color': 'black',
            'line-color': 'black',
            'target-arrow-color': 'black',
            'source-arrow-color': 'black'
          })
        .selector('.action')
          .css({
            'background-color': backgroundColourForNodeClass('.action'),
          })
        .selector('.gate')
          .css({
            'background-color': backgroundColourForNodeClass('.gate'),
          }),

      elements: state_machine_config,

      layout: layoutOptions
    });

    function changeSpacing(value) {
      layoutOptions.spacingFactor = value;
      displaySpacingFactor();
      cy.layout(layoutOptions).run();
    }

    var initialSpacingFactor = 0.35 + cy.nodes().length * 0.029;
    document.getElementById('spacing-factor').value = initialSpacingFactor * 10;
    changeSpacing(initialSpacingFactor);
  </script>
</body>
</html>
